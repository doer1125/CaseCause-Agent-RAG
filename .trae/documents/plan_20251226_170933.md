# 法律文档处理与索引优化方案

## 1. 问题分析

当前法律文档处理存在以下问题：

* **固定Chunk大小**：使用固定的1000字符Chunk，不考虑文档结构
* **缺乏上下文元数据**：只添加了基本元数据，没有包含文档结构信息
* **单一层索引**：所有内容都在同一索引层，检索效率低
* **分词不够精准**：没有针对法律文档的特点进行优化

## 2. 优化目标

* **自适应Chunk划分**：根据文档结构动态调整Chunk大小
* **丰富上下文元数据**：包含章节、段落等结构信息
* **分层索引结构**：分为摘要层和细节层
* **优化检索流程**：先检索摘要层，再深入细节层

## 3. 优化方案

### 3.1 文档结构感知的Chunk划分

#### 3.1.1 设计思路

* 保留文档的章节、段落结构
* 根据文档结构动态调整Chunk大小
* 重要章节使用较大Chunk，细节内容使用较小Chunk

#### 3.1.2 实现步骤

1. **改进文档加载**：使用更强大的文档加载器，保留文档结构

2. **结构分析**：识别文档的章节、段落结构

3. **自适应Chunk划分**：
   - 章节标题单独作为Chunk
   - 重要章节内容使用较大Chunk
   - 细节内容使用较小Chunk
   - 保持段落的完整性

### 3.2 上下文元数据增强

#### 3.2.1 设计思路

* 为每个Chunk添加丰富的上下文信息
* 包含文档结构、层次关系等元数据

#### 3.2.2 元数据设计

```python
metadata = {
    "文档类型": "法律条款",
    "文档名称": "医疗机构管理条例",
    "章节": "第一章 总则",
    "段落": "第一条",
    "层级": 2,  # 1-章节，2-段落，3-子段落
    "父节点": "第一章 总则",
    "Chunk类型": "摘要"  # 或 "细节"
    "页码": 1,
    "来源": "医疗机构管理条例_20220329.docx"
}
```

### 3.3 分层索引结构

#### 3.3.1 设计思路

* **摘要层**：包含文档的章节标题、段落摘要
* **细节层**：包含完整的条款内容
* **优先检索摘要层**，根据需要深入细节层

#### 3.3.2 实现步骤

1. **摘要生成**：为每个章节、段落生成摘要

2. **分层存储**：
   - 摘要层：存储章节标题和段落摘要
   - 细节层：存储完整的条款内容

3. **分层检索**：
   - 第一步：检索摘要层，获取相关章节
   - 第二步：根据摘要层结果，检索对应细节层内容

## 4. 实现方案

### 4.1 代码结构调整

1. 改进 `encode_word` 函数，实现自适应Chunk划分
2. 添加 `generate_summary` 函数，生成文档摘要
3. 添加 `create_hierarchical_index` 函数，创建分层索引
4. 改进检索流程，实现分层检索

### 4.2 核心方法设计

```python
def encode_word(path, adaptive_chunking=True, hierarchical_index=True):
    """改进的Word文档编码函数，支持自适应Chunk划分和分层索引"""
    # 加载文档，保留结构信息
    # 实现自适应Chunk划分
    # 生成摘要
    # 创建分层索引
    # 返回向量存储
    pass

def adaptive_chunk_split(documents, min_chunk_size=500, max_chunk_size=2000):
    """自适应Chunk划分算法"""
    # 根据文档结构动态调整Chunk大小
    # 保留章节、段落结构
    pass

def create_hierarchical_index(chunks):
    """创建分层索引"""
    # 生成摘要层
    # 生成细节层
    # 组合分层索引
    pass
```

### 4.3 技术栈

* **文档加载**：python-docx
* **摘要生成**：BART-base-chinese或T5-small-chinese
* **嵌入模型**：BGE-large-zh
* **向量存储**：FAISS

## 5. 实现步骤

1. 改进文档加载，保留文档结构信息
2. 实现自适应Chunk划分算法
3. 添加丰富的上下文元数据
4. 实现分层索引结构
5. 优化检索流程
6. 测试优化效果

## 6. 预期效果

* **检索效率提升**：优先检索摘要层，减少检索范围
* **检索准确性提高**：基于文档结构的Chunk划分，保留语义完整性
* **上下文理解增强**：丰富的元数据提供更多上下文信息
* **灵活的检索方式**：支持从摘要到细节的递进检索

## 7. 测试计划

* 使用指定的法律文件进行测试
* 比较优化前后的检索效果
* 评估检索效率和准确性
* 测试不同Chunk大小的影响

## 8. 技术实现要点

* **文档结构识别**：使用正则表达式或NLP模型识别章节结构
* **摘要生成**：使用轻量级LLM生成准确摘要
* **分层索引管理**：使用不同的向量存储或同一向量存储的不同命名空间
* **检索流程优化**：实现两阶段检索，先摘要后细节

这个优化方案将显著提高法律文档的处理和检索效果，特别是对于复杂的法律条款文档。
