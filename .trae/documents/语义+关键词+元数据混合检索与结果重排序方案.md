# 语义+关键词+元数据混合检索与结果重排序方案

## 一、方案概述

本方案将实现对指定文档（案由清单.xlsx和最新版《行政处罚法》.docx）的混合检索，包括：
1. **语义检索**：基于BGE-large-zh嵌入模型的向量相似度检索
2. **关键词检索**：基于BM25算法的关键词匹配检索
3. **元数据检索**：基于文档元数据的过滤检索
4. **结果重排序**：将三种检索结果融合并重新排序

## 二、实施步骤

### 步骤1：增强文档元数据

**目标**：为文档添加更丰富的元数据，便于元数据检索

**修改内容**：
- 修改`encode_excel`函数，为Excel文档添加更详细的元数据
- 修改`encode_word`函数，为Word文档添加章节、页码等元数据

**具体实现**：
- Excel文档：添加案由类型、编号等元数据
- Word文档：添加章节标题、段落编号等元数据

### 步骤2：实现关键词检索

**目标**：添加基于BM25算法的关键词检索功能

**依赖库**：
```bash
pip install rank-bm25
```

**实现内容**：
- 创建`BM25Retriever`类，实现关键词检索
- 为每个文档集合构建BM25索引
- 实现关键词匹配分数计算

### 步骤3：实现元数据过滤

**目标**：添加基于元数据的过滤功能

**实现内容**：
- 扩展向量存储的检索功能，支持元数据过滤
- 实现元数据查询语言，支持多种条件组合
- 整合到现有检索流程中

### 步骤4：实现结果融合与重排序

**目标**：将语义、关键词、元数据检索结果融合并重新排序

**实现内容**：
- 实现线性融合算法，将不同检索方式的分数加权合并
- 添加可调节的权重参数，支持根据需求调整各检索方式的重要性
- 实现结果去重和排序

### 步骤5：整合到现有代码中

**目标**：将混合检索功能整合到现有项目中

**实现内容**：
- 修改`create_retrievers`函数，返回混合检索器
- 更新`retrieve_context_per_question`函数，支持混合检索
- 添加配置参数，支持灵活切换检索模式

## 三、技术选型

| 功能 | 技术/库 | 版本 |
|------|---------|------|
| 语义嵌入 | BGE-large-zh | - |
| 向量存储 | FAISS | 1.8.0 |
| 关键词检索 | rank-bm25 | - |
| 元数据处理 | langchain | 最新 |
| 结果重排序 | 自定义线性融合 | - |

## 四、预期效果

1. **提高检索准确性**：结合多种检索方式，提高相关文档的召回率和精确率
2. **增强检索灵活性**：支持多种检索条件组合，满足不同场景需求
3. **提升用户体验**：返回更相关的结果，减少用户筛选时间
4. **保持系统性能**：优化检索流程，确保检索速度满足需求

## 五、实施时间线

1. **第1天**：增强文档元数据，实现关键词检索
2. **第2天**：实现元数据检索，整合检索结果
3. **第3天**：实现结果重排序，测试和优化
4. **第4天**：文档编写，最终测试

## 六、测试方案

1. **单元测试**：测试各组件功能是否正常
2. **集成测试**：测试混合检索流程是否顺畅
3. **性能测试**：测试检索速度和资源占用
4. **效果评估**：评估检索结果的相关性和准确性

## 七、风险评估

1. **性能风险**：混合检索可能增加系统响应时间，需优化算法和索引
2. **复杂性风险**：多组件整合可能增加系统复杂性，需良好的模块化设计
3. **配置风险**：权重参数需要调整以获得最佳效果，需进行充分测试

## 八、后续优化方向

1. **引入更高级的重排序算法**：如学习排序（Learning to Rank）
2. **支持动态权重调整**：根据用户反馈自动调整各检索方式的权重
3. **添加检索历史记录**：支持基于历史检索的个性化推荐
4. **实现增量更新**：支持文档的增量更新和索引重建