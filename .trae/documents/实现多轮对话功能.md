# 多轮对话功能实现计划

## 1. 增强对话管理系统

### 1.1 对话状态管理
- 扩展 `Conversation` 类，添加 `dialogue_state` 字段，用于跟踪当前对话任务类型和进度
- 实现状态转换逻辑，支持从投诉描述到要点提取再到案由检索的完整流程
- 添加对话意图识别功能，判断用户当前意图（如：投诉描述、追问、请求生成文书等）

### 1.2 上下文理解增强
- 改进 `ContextFuser` 类，支持基于对话状态的动态上下文压缩
- 添加对话历史中的关键信息提取，如已识别的投诉类型、已检索的案由等
- 实现上下文关联，确保后续查询能基于之前的对话内容

## 2. 多轮对话流程设计

### 2.1 投诉要点提取流程
1. 用户输入投诉描述
2. 系统提取投诉要点并展示
3. 系统询问用户是否需要调整或补充
4. 用户确认或修改投诉要点

### 2.2 案由/法律法规检索流程
1. 基于确认的投诉要点检索相关案由
2. 展示检索结果，询问用户是否需要进一步检索法律法规
3. 根据用户需求，检索相关法律法规

### 2.3 文书生成流程
1. 用户请求生成文书
2. 系统收集必要信息（如投诉人信息、投诉对象信息等）
3. 基于完整信息生成相应文书
4. 展示生成结果，允许用户调整

## 3. API接口扩展

### 3.1 增强现有接口
- 扩展 `/api/chat` 接口，支持对话状态传递和意图识别
- 添加对话状态查询接口，允许前端获取当前对话进度

### 3.2 新增功能接口
- 投诉要点确认接口，用于用户确认或修改提取的投诉要点
- 文书生成请求接口，支持指定文书类型和生成参数
- 对话重置接口，允许用户重新开始对话流程

## 4. 集成文书生成功能

### 4.1 文书模板管理
- 设计常见投诉文书模板（如投诉书、举报信等）
- 实现模板参数化，支持动态填充内容

### 4.2 基于对话历史的文书生成
- 利用对话历史中的投诉要点、检索到的案由和法律法规生成文书
- 支持根据用户反馈调整文书内容

## 5. 前端交互优化

### 5.1 对话流程引导
- 实现对话状态提示，引导用户完成整个流程
- 添加进度指示器，显示当前所处的流程阶段

### 5.2 交互式信息补充
- 实现分步信息收集，根据需要向用户询问补充信息
- 支持对提取的投诉要点进行交互式修改

## 6. 测试与优化

### 6.1 功能测试
- 测试完整的多轮对话流程
- 测试不同类型投诉的处理效果

### 6.2 性能优化
- 优化对话历史管理，减少内存占用
- 优化检索和生成速度，提高响应效率

### 6.3 用户体验优化
- 根据测试反馈调整对话流程
- 优化系统提示和引导语

## 实现步骤

1. 增强 `conversation_manager.py` 中的对话状态管理功能
2. 实现对话意图识别模块
3. 扩展 `app.py` 中的API接口
4. 集成文书生成功能
5. 优化前端交互逻辑
6. 进行功能测试和性能优化

通过以上计划，我们将实现一个完整的多轮对话系统，使用户能够通过自然对话方式完成投诉要点提取、案由/法律法规检索和文书生成等功能。