# 复杂流程可解释性增强方案

## 1. 需求分析
为增强用户信任与运维调试，需要设计推理过程的可视化追溯模块，清晰展示：
- Agent的决策路径
- 工具调用及执行过程
- 法条引用来源

## 2. 实现方案

### 2.1 设计推理轨迹数据模型
创建`reasoning_trace.py`文件，定义推理轨迹数据结构：
```python
class ReasoningStep:
    """推理步骤"""
    def __init__(self, step_type: str, description: str, data: dict = None):
        self.step_type = step_type  # 步骤类型：context_fusion, retrieval, reranking, response_generation
        self.description = description  # 步骤描述
        self.data = data or {}  # 步骤数据
        self.timestamp = datetime.now()  # 时间戳

class ReasoningTrace:
    """推理轨迹"""
    def __init__(self, session_id: str, query: str):
        self.session_id = session_id  # 会话ID
        self.query = query  # 原始查询
        self.steps = []  # 推理步骤列表
        self.created_at = datetime.now()  # 创建时间
    
    def add_step(self, step_type: str, description: str, data: dict = None):
        """添加推理步骤"""
        step = ReasoningStep(step_type, description, data)
        self.steps.append(step)
```

### 2.2 增强现有组件的日志记录
- **conversation_manager.py**：记录上下文融合过程、重要性计算、压缩策略
- **Rag_Retrieved.py**：记录检索策略选择、语义检索结果、BM25检索结果、检索分数
- **bm25_retriever.py**：记录BM25检索分数和匹配关键词
- **reranker.py**：记录重排序过程、加权分数、元数据匹配情况

### 2.3 创建推理轨迹管理模块
- 实现推理轨迹的存储和查询功能
- 支持按会话ID查询完整推理过程
- 支持推理轨迹的序列化和反序列化

### 2.4 扩展API响应模型
- 修改`ChatResponse`模型，添加`reasoning_trace`字段
- 提供专门的API端点`/api/conversations/{session_id}/reasoning`获取完整推理轨迹

### 2.5 实现可视化追溯界面
- 设计结构化的推理轨迹数据格式，便于前端可视化
- 包含决策路径图、工具调用时序图、法条引用关系图

## 3. 实施步骤
1. 创建`reasoning_trace.py`，定义推理轨迹数据模型
2. 修改现有组件，集成推理轨迹记录
3. 实现推理轨迹管理模块
4. 扩展API响应模型和端点
5. 测试完整流程

## 4. 预期效果
- 每个对话请求都会生成完整的推理轨迹
- API响应中包含结构化的推理过程信息
- 支持查看Agent的决策路径、工具调用和法条引用
- 便于运维调试和用户信任增强